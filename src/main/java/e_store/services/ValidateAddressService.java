package e_store.services;

import com.jayway.jsonpath.JsonPath;
import e_store.database.entity.Address;
import e_store.proxy.AddressProxy;
import jakarta.validation.ValidationException;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

@Service
public class ValidateAddressService {

    private static final String FAIL_PATH = "$.response.GeoObjectCollection.metaDataProperty.GeocoderResponseMetaData.found";
    private static final String SUCC_PATH = "$.response.GeoObjectCollection.featureMember[0].GeoObject.metaDataProperty.GeocoderMetaData.Address.formatted";

    private final String apiKey;
    private final AddressProxy addressProxy;

    public ValidateAddressService(AddressProxy addressProxy,
                                  @Value("${API_KEY}") String apiKey) {
        this.addressProxy = addressProxy;
        this.apiKey = apiKey;
    }

    public Address valid(Address incAddress) {
        String geocodeRequest = incAddress.getCity() + " " + incAddress.getStreetAddress();
        String json = addressProxy.getGeoData(apiKey, geocodeRequest, "3", "json");

        int found = Integer.parseInt(JsonPath.read(json, FAIL_PATH).toString());
        if (found == 0) throw new ValidationException("Address not found!");
        else if (found > 1) throw new ValidationException("More than one address match!");
        else {
            String result = JsonPath.read(json, SUCC_PATH);
            String[] resultMassive = result.split(", ");

            return new Address(null, resultMassive[1], result.substring(resultMassive[0].length() + resultMassive[1].length() + 4));
        }
    }
}


        /*
        {"response":{"GeoObjectCollection":{"metaDataProperty":{"GeocoderResponseMetaData":{"request":"cjhfgaedafdafd","results":"10","found":"0"}},"featureMember":[]}}}

        {"response":{"GeoObjectCollection":{"metaDataProperty":{"GeocoderResponseMetaData":{"request":"улица ленина дом 10","results":"10","found":"10"}},"featureMember":[{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Россия, Киров, улица Ленина, 10","kind":"house","Address":{"country_code":"RU","formatted":"Россия, Киров, улица Ленина, 10","Components":[{"kind":"country","name":"Россия"},{"kind":"province","name":"Приволжский федеральный округ"},{"kind":"province","name":"Кировская область"},{"kind":"area","name":"муниципальное образование Киров"},{"kind":"locality","name":"Киров"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Россия, Киров, улица Ленина, 10","CountryNameCode":"RU","CountryName":"Россия","AdministrativeArea":{"AdministrativeAreaName":"Кировская область","SubAdministrativeArea":{"SubAdministrativeAreaName":"муниципальное образование Киров","Locality":{"LocalityName":"Киров","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10"}}}}}}}}},"name":"улица Ленина, 10","description":"Киров, Россия","boundedBy":{"Envelope":{"lowerCorner":"49.676377 58.612169","upperCorner":"49.684588 58.616453"}},"uri":"ymapsbm1://geo?data=Cgg1NjMzNTMyNhI10KDQvtGB0YHQuNGPLCDQmtC40YDQvtCyLCDRg9C70LjRhtCwINCb0LXQvdC40L3QsCwgMTAiCg3RuEZCFQ91akI,","Point":{"pos":"49.680482 58.614311"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Россия, Удмуртская Республика, Ижевск, улица Ленина, 10","kind":"house","Address":{"country_code":"RU","formatted":"Россия, Удмуртская Республика, Ижевск, улица Ленина, 10","postal_code":"426008","Components":[{"kind":"country","name":"Россия"},{"kind":"province","name":"Приволжский федеральный округ"},{"kind":"province","name":"Удмуртская Республика"},{"kind":"area","name":"городской округ Ижевск"},{"kind":"locality","name":"Ижевск"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Россия, Удмуртская Республика, Ижевск, улица Ленина, 10","CountryNameCode":"RU","CountryName":"Россия","AdministrativeArea":{"AdministrativeAreaName":"Удмуртская Республика","SubAdministrativeArea":{"SubAdministrativeAreaName":"городской округ Ижевск","Locality":{"LocalityName":"Ижевск","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10","PostalCode":{"PostalCodeNumber":"426008"}}}}}}}}}},"name":"улица Ленина, 10","description":"Ижевск, Удмуртская Республика, Россия","boundedBy":{"Envelope":{"lowerCorner":"53.203352 56.841148","upperCorner":"53.211562 56.845647"}},"uri":"ymapsbm1://geo?data=Cgg1NjIxMDU2NhJi0KDQvtGB0YHQuNGPLCDQo9C00LzRg9GA0YLRgdC60LDRjyDQoNC10YHQv9GD0LHQu9C40LrQsCwg0JjQttC10LLRgdC6LCDRg9C70LjRhtCwINCb0LXQvdC40L3QsCwgMTAiCg1v1FRCFaRfY0I,","Point":{"pos":"53.207457 56.843398"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Россия, Ставрополь, улица Ленина, 10","kind":"house","Address":{"country_code":"RU","formatted":"Россия, Ставрополь, улица Ленина, 10","postal_code":"355020","Components":[{"kind":"country","name":"Россия"},{"kind":"province","name":"Северо-Кавказский федеральный округ"},{"kind":"province","name":"Ставропольский край"},{"kind":"area","name":"городской округ Ставрополь"},{"kind":"locality","name":"Ставрополь"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Россия, Ставрополь, улица Ленина, 10","CountryNameCode":"RU","CountryName":"Россия","AdministrativeArea":{"AdministrativeAreaName":"Ставропольский край","SubAdministrativeArea":{"SubAdministrativeAreaName":"городской округ Ставрополь","Locality":{"LocalityName":"Ставрополь","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10","PostalCode":{"PostalCodeNumber":"355020"}}}}}}}}}},"name":"улица Ленина, 10","description":"Ставрополь, Россия","boundedBy":{"Envelope":{"lowerCorner":"42.007145 45.040114","upperCorner":"42.015356 45.045935"}},"uri":"ymapsbm1://geo?data=Cgg1NzU0NzQwNBI_0KDQvtGB0YHQuNGPLCDQodGC0LDQstGA0L7Qv9C-0LvRjCwg0YPQu9C40YbQsCDQm9C10L3QuNC90LAsIDEwIgoNhgsoQhUOLDRC","Point":{"pos":"42.01125 45.043024"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Кыргызстан, Ош, улица Ленина, 10","kind":"house","Address":{"country_code":"KG","formatted":"Кыргызстан, Ош, улица Ленина, 10","Components":[{"kind":"country","name":"Кыргызстан"},{"kind":"province","name":"город республиканского подчинения Ош"},{"kind":"locality","name":"Ош"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Кыргызстан, Ош, улица Ленина, 10","CountryNameCode":"KG","CountryName":"Кыргызстан","AdministrativeArea":{"AdministrativeAreaName":"город республиканского подчинения Ош","Locality":{"LocalityName":"Ош","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10"}}}}}}}},"name":"улица Ленина, 10","description":"Ош, Кыргызстан","boundedBy":{"Envelope":{"lowerCorner":"72.815434 40.493923","upperCorner":"72.823644 40.500191"}},"uri":"ymapsbm1://geo?data=CgoyMjEyMTgyNDQ0EjfQmtGL0YDQs9GL0LfRgdGC0LDQvSwg0J7RiCwg0JvQtdC90LjQvSDQutOp0YfTqdGB0q8sIDEwIgoNmqORQhX8_CFC","Point":{"pos":"72.819539 40.497057"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Россия, Сахалинская область, Южно-Сахалинск, улица Ленина, 10","kind":"house","Address":{"country_code":"RU","formatted":"Россия, Сахалинская область, Южно-Сахалинск, улица Ленина, 10","postal_code":"693003","Components":[{"kind":"country","name":"Россия"},{"kind":"province","name":"Дальневосточный федеральный округ"},{"kind":"province","name":"Сахалинская область"},{"kind":"area","name":"городской округ Южно-Сахалинск"},{"kind":"locality","name":"Южно-Сахалинск"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Россия, Сахалинская область, Южно-Сахалинск, улица Ленина, 10","CountryNameCode":"RU","CountryName":"Россия","AdministrativeArea":{"AdministrativeAreaName":"Сахалинская область","SubAdministrativeArea":{"SubAdministrativeAreaName":"городской округ Южно-Сахалинск","Locality":{"LocalityName":"Южно-Сахалинск","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10","PostalCode":{"PostalCodeNumber":"693003"}}}}}}}}}},"name":"улица Ленина, 10","description":"Южно-Сахалинск, Сахалинская область, Россия","boundedBy":{"Envelope":{"lowerCorner":"142.716733 46.975604","upperCorner":"142.724943 46.981224"}},"uri":"ymapsbm1://geo?data=Cgg1NzkxNzY2MBJt0KDQvtGB0YHQuNGPLCDQodCw0YXQsNC70LjQvdGB0LrQsNGPINC-0LHQu9Cw0YHRgtGMLCDQrtC20L3Qvi3QodCw0YXQsNC70LjQvdGB0LosINGD0LvQuNGG0LAg0JvQtdC90LjQvdCwLCAxMCIKDYm4DkMV5uk7Qg,,","Point":{"pos":"142.720838 46.978414"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Россия, Ханты-Мансийский автономный округ — Югра, Нижневартовск, улица Ленина, 10","kind":"house","Address":{"country_code":"RU","formatted":"Россия, Ханты-Мансийский автономный округ — Югра, Нижневартовск, улица Ленина, 10","postal_code":"628606","Components":[{"kind":"country","name":"Россия"},{"kind":"province","name":"Уральский федеральный округ"},{"kind":"province","name":"Тюменская область"},{"kind":"province","name":"Ханты-Мансийский автономный округ — Югра"},{"kind":"area","name":"городской округ Нижневартовск"},{"kind":"locality","name":"Нижневартовск"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Россия, Ханты-Мансийский автономный округ — Югра, Нижневартовск, улица Ленина, 10","CountryNameCode":"RU","CountryName":"Россия","AdministrativeArea":{"AdministrativeAreaName":"Тюменская область","SubAdministrativeArea":{"SubAdministrativeAreaName":"Ханты-Мансийский автономный округ — Югра","Locality":{"LocalityName":"Нижневартовск","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10","PostalCode":{"PostalCodeNumber":"628606"}}}}}}}}}},"name":"улица Ленина, 10","description":"Нижневартовск, Ханты-Мансийский автономный округ — Югра, Россия","boundedBy":{"Envelope":{"lowerCorner":"76.556926 60.937164","upperCorner":"76.565136 60.941158"}},"uri":"ymapsbm1://geo?data=CgoxOTI1MDk0OTExEpMB0KDQvtGB0YHQuNGPLCDQpdCw0L3RgtGLLdCc0LDQvdGB0LjQudGB0LrQuNC5INCw0LLRgtC-0L3QvtC80L3Ri9C5INC-0LrRgNGD0LMg4oCUINCu0LPRgNCwLCDQndC40LbQvdC10LLQsNGA0YLQvtCy0YHQuiwg0YPQu9C40YbQsCDQm9C10L3QuNC90LAsIDEwIgoNQB-ZQhW0wXNC","Point":{"pos":"76.561031 60.939161"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Казахстан, Костанайская область, Рудный, улица Ленина, 10","kind":"house","Address":{"country_code":"KZ","formatted":"Казахстан, Костанайская область, Рудный, улица Ленина, 10","Components":[{"kind":"country","name":"Казахстан"},{"kind":"province","name":"Костанайская область"},{"kind":"area","name":"городской акимат Рудный"},{"kind":"locality","name":"Рудный"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Казахстан, Костанайская область, Рудный, улица Ленина, 10","CountryNameCode":"KZ","CountryName":"Казахстан","AdministrativeArea":{"AdministrativeAreaName":"Костанайская область","SubAdministrativeArea":{"SubAdministrativeAreaName":"городской акимат Рудный","Locality":{"LocalityName":"Рудный","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10"}}}}}}}},"ReferencesMetaData":{"references":[{"id":"392410000","scope":"kz:kato"}]}},"name":"улица Ленина, 10","description":"Рудный, Костанайская область, Казахстан","boundedBy":{"Envelope":{"lowerCorner":"63.136661 52.962675","upperCorner":"63.144872 52.967632"}},"uri":"ymapsbm1://geo?data=CgoxNTQ1NDgxMDcyElzSmtCw0LfQsNKb0YHRgtCw0L0sINKa0L7RgdGC0LDQvdCw0Lkg0L7QsdC70YvRgdGLLCDQoNGD0LTQvdGL0LksINCb0LXQvdC40L0g0LrTqdGI0LXRgdGWLCAxMCIKDSWQfEIVUdxTQg,,","Point":{"pos":"63.140767 52.965153"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Россия, Свердловская область, Серов, улица Ленина, 10","kind":"house","Address":{"country_code":"RU","formatted":"Россия, Свердловская область, Серов, улица Ленина, 10","postal_code":"624990","Components":[{"kind":"country","name":"Россия"},{"kind":"province","name":"Уральский федеральный округ"},{"kind":"province","name":"Свердловская область"},{"kind":"area","name":"Серовский муниципальный округ"},{"kind":"locality","name":"Серов"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Россия, Свердловская область, Серов, улица Ленина, 10","CountryNameCode":"RU","CountryName":"Россия","AdministrativeArea":{"AdministrativeAreaName":"Свердловская область","SubAdministrativeArea":{"SubAdministrativeAreaName":"Серовский муниципальный округ","Locality":{"LocalityName":"Серов","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10","PostalCode":{"PostalCodeNumber":"624990"}}}}}}}}}},"name":"улица Ленина, 10","description":"Серов, Свердловская область, Россия","boundedBy":{"Envelope":{"lowerCorner":"60.527738 59.607244","upperCorner":"60.535949 59.611405"}},"uri":"ymapsbm1://geo?data=CgoxOTI5NDg4NjYxEl7QoNC-0YHRgdC40Y8sINCh0LLQtdGA0LTQu9C-0LLRgdC60LDRjyDQvtCx0LvQsNGB0YLRjCwg0KHQtdGA0L7Qsiwg0YPQu9C40YbQsCDQm9C10L3QuNC90LAsIDEwIgoNmyByQhXyb25C","Point":{"pos":"60.531844 59.609324"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Беларусь, Минская область, Слуцк, улица Ленина, 10","kind":"house","Address":{"country_code":"BY","formatted":"Беларусь, Минская область, Слуцк, улица Ленина, 10","Components":[{"kind":"country","name":"Беларусь"},{"kind":"province","name":"Минская область"},{"kind":"area","name":"Слуцкий район"},{"kind":"locality","name":"Слуцк"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Беларусь, Минская область, Слуцк, улица Ленина, 10","CountryNameCode":"BY","CountryName":"Беларусь","AdministrativeArea":{"AdministrativeAreaName":"Минская область","SubAdministrativeArea":{"SubAdministrativeAreaName":"Слуцкий район","Locality":{"LocalityName":"Слуцк","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10"}}}}}}}}},"name":"улица Ленина, 10","description":"Слуцк, Минская область, Беларусь","boundedBy":{"Envelope":{"lowerCorner":"27.504411 53.009893","upperCorner":"27.512621 53.014844"}},"uri":"ymapsbm1://geo?data=CgoxOTU5ODQwMzk0ElzQkdC10LvQsNGA0YPRgdGMLCDQnNGW0L3RgdC60LDRjyDQstC-0LHQu9Cw0YHRhtGMLCDQodC70YPRhtC6LCDQstGD0LvRltGG0LAg0JvQtdC90ZbQvdCwLCAxMCIKDXER3EEVqgxUQg,,","Point":{"pos":"27.508516 53.012369"}}},{"GeoObject":{"metaDataProperty":{"GeocoderMetaData":{"precision":"exact","text":"Россия, Краснодарский край, Сочи, улица Ленина, 10","kind":"house","Address":{"country_code":"RU","formatted":"Россия, Краснодарский край, Сочи, улица Ленина, 10","Components":[{"kind":"country","name":"Россия"},{"kind":"province","name":"Южный федеральный округ"},{"kind":"province","name":"Краснодарский край"},{"kind":"area","name":"городской округ Сочи"},{"kind":"locality","name":"Сочи"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]},"AddressDetails":{"Country":{"AddressLine":"Россия, Краснодарский край, Сочи, улица Ленина, 10","CountryNameCode":"RU","CountryName":"Россия","AdministrativeArea":{"AdministrativeAreaName":"Краснодарский край","SubAdministrativeArea":{"SubAdministrativeAreaName":"городской округ Сочи","Locality":{"LocalityName":"Сочи","Thoroughfare":{"ThoroughfareName":"улица Ленина","Premise":{"PremiseNumber":"10"}}}}}}}}},"name":"улица Ленина, 10","description":"Сочи, Краснодарский край, Россия","boundedBy":{"Envelope":{"lowerCorner":"39.917188 43.425596","upperCorner":"39.925398 43.43158"}},"uri":"ymapsbm1://geo?data=Cgg1NzUzMjAyNRJY0KDQvtGB0YHQuNGPLCDQmtGA0LDRgdC90L7QtNCw0YDRgdC60LjQuSDQutGA0LDQuSwg0KHQvtGH0LgsINGD0LvQuNGG0LAg0JvQtdC90LjQvdCwLCAxMCIKDWivH0IV4LYtQg,,","Point":{"pos":"39.921293 43.428588"}}}]}}}

        "Address":{"country_code":"RU","formatted":"Россия, Киров, улица Ленина, 10","Components":[{"kind":"locality","name":"Киров"},{"kind":"street","name":"улица Ленина"},{"kind":"house","name":"10"}]
         */